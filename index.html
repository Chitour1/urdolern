<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>حكايتي الأردية - تعلم الأردية بالذكاء الاصطناعي</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&family=Noto+Nastaliq+Urdu:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Cairo', sans-serif;
        }
        .font-urdu {
            font-family: 'Noto Nastaliq Urdu', serif;
        }
        .lesson-content b, .lesson-content .word-span {
             cursor: pointer;
        }
        .lesson-content b:hover, .lesson-content .word-span:hover {
            background-color: #e0f2fe;
        }
        .dialogue-line {
            margin-bottom: 1.5rem;
        }
        .dialogue-speaker-1 { color: #1d4ed8; font-weight: bold; }
        .dialogue-speaker-2 { color: #be185d; font-weight: bold; }
        .loader {
            border: 5px solid #f3f3f3; border-top: 5px solid #3498db;
            border-radius: 50%; width: 50px; height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .modal-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0, 0, 0, 0.5); display: flex;
            align-items: center; justify-content: center; z-index: 1000;
        }
        .modal-content {
            background: white; padding: 2rem; border-radius: 8px;
            max-width: 90%; width: 450px; text-align: center;
        }
        .table-style { width: 100%; border-collapse: collapse; }
        .table-style th, .table-style td {
            border: 1px solid #e2e8f0;
            padding: 12px; 
            text-align: right;
        }
        .table-style th { background-color: #f1f5f9; }
        .table-style td:first-child {
            font-weight: bold; font-family: 'Noto Nastaliq Urdu', serif;
        }
        /* Flashcard styles */
        .flashcard-container { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 1rem; }
        .flashcard {
            background-color: white; border: 1px solid #e2e8f0; border-radius: 8px;
            height: 100px; 
            perspective: 1000px; cursor: pointer;
        }
        .flashcard-inner {
            position: relative; width: 100%; height: 100%; text-align: center;
            transition: transform 0.6s; transform-style: preserve-3d;
        }
        .flashcard.is-flipped .flashcard-inner { transform: rotateY(180deg); }
        .flashcard-front, .flashcard-back {
            position: absolute; width: 100%; height: 100%; -webkit-backface-visibility: hidden;
            backface-visibility: hidden; display: flex; align-items: center; justify-content: center;
            padding: 1rem; font-size: 1.2rem;
        }
        .flashcard-front { font-family: 'Noto Nastaliq Urdu', serif; }
        .flashcard-back { transform: rotateY(180deg); background-color: #f0f9ff; }
        /* Matching exercise styles */
        .matching-container { display: flex; justify-content: space-around; gap: 1rem; }
        .matching-column { display: flex; flex-direction: column; gap: 0.5rem; flex: 1; }
        .match-item {
            padding: 0.75rem; 
            border: 2px solid #cbd5e1; border-radius: 6px;
            cursor: pointer; transition: all 0.2s; font-size: 1.1rem;
        }
        .match-item.selected { border-color: #3b82f6; background-color: #dbeafe; }
        .match-item.correct { border-color: #22c55e; background-color: #dcfce7; pointer-events: none; }
        .match-item.incorrect { border-color: #ef4444; background-color: #fee2e2; }
        .exercise {
            margin-bottom: 1rem; 
        }
        /* Alphabet styles */
        .alphabet-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
            gap: 0.75rem;
            direction: rtl;
        }
        .letter-card {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 70px;
            border: 1px solid #cbd5e1;
            border-radius: 8px;
            font-size: 2rem;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
        }
        .letter-card:hover {
            background-color: #e0f2fe;
            border-color: #3b82f6;
            transform: scale(1.05);
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800">

    <div id="app" class="container mx-auto p-4 md:p-8 max-w-4xl">
        
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-sky-600 mb-2 font-urdu">حکایتی الأردیة</h1>
            <p class="text-lg text-slate-600">تعلم مفردات الأردية من خلال قصص يصنعها الذكاء الاصطناعي</p>
        </header>

        <div id="api-key-section" class="mb-6 p-4 bg-white rounded-lg shadow-md">
            <div class="flex items-center gap-3 mb-3">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-amber-500"><path d="M14 9a2 2 0 0 1-2 2H6l-4 4V4c0-1.1.9-2 2-2h8a2 2 0 0 1 2 2v5Z"/><path d="M18 9h2a2 2 0 0 1 2 2v10l-4-4H8a2 2 0 0 1-2-2V9a2 2 0 0 1 2-2h2"/><path d="M22 12h-2"/><path d="M18 12h-2"/></svg>
                <h2 class="text-xl font-bold">مفتاح Gemini API</h2>
            </div>
            <p class="text-slate-600 mb-3 text-sm">لاستخدام التطبيق، يرجى إدخال مفتاح Gemini API الخاص بك. يمكنك الحصول عليه من <a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-sky-600 hover:underline">Google AI Studio</a>.</p>
            <div class="flex flex-col sm:flex-row gap-2">
                <input type="password" id="api-key-input" class="flex-grow p-2 border rounded-md" placeholder="أدخل مفتاحك هنا...">
                <button id="save-api-key-btn" class="bg-sky-600 text-white px-6 py-2 rounded-md hover:bg-sky-700 transition">حفظ وبدء</button>
            </div>
        </div>

        <main id="main-content" class="hidden">
            
            <div class="mb-6 flex justify-center border-b flex-wrap">
                <button id="nav-home" class="px-4 py-3 text-lg font-bold border-b-4 border-sky-600 text-sky-600">الرئيسية</button>
                <button id="nav-alphabet" class="px-4 py-3 text-lg font-bold border-b-4 border-transparent text-slate-500 hover:text-sky-600">الحروف</button>
                <button id="nav-history" class="px-4 py-3 text-lg font-bold border-b-4 border-transparent text-slate-500 hover:text-sky-600">سجل الدروس</button>
                <button id="nav-learned" class="px-4 py-3 text-lg font-bold border-b-4 border-transparent text-slate-500 hover:text-sky-600">الكلمات المتعلمة</button>
                <button id="nav-basket" class="px-4 py-3 text-lg font-bold border-b-4 border-transparent text-slate-500 hover:text-sky-600">سلة التعلم</button>
            </div>
            
            <div id="stats-section" class="mb-6 p-4 bg-white rounded-lg shadow-md flex flex-wrap justify-around text-center">
                <div><p class="text-slate-500">إجمالي الكلمات</p><p id="total-words" class="text-2xl font-bold text-sky-600">0</p></div>
                <div><p class="text-slate-500">كلمات تعلمتها</p><p id="learned-words" class="text-2xl font-bold text-green-600">0</p></div>
                <div><p class="text-slate-500">الكلمات المتبقية</p><p id="remaining-words" class="text-2xl font-bold text-amber-600">0</p></div>
            </div>

            <div id="home-screen" class="text-center p-8 bg-white rounded-lg shadow-md">
                <h2 class="text-2xl font-bold mb-4">هل أنت مستعد لدرس جديد؟</h2>
                <p class="text-slate-600 mb-6">اضغط على الزر أدناه ليقوم الذكاء الاصطناعي بإنشاء قصة جديدة لك من 15-20 كلمة لم تتعلمها بعد.</p>
                <button id="new-lesson-btn" class="bg-green-600 text-white px-8 py-3 rounded-lg text-lg font-bold hover:bg-green-700 transition transform hover:scale-105">
                    <span class="flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 5v14"/><path d="M5 12h14"/></svg>
                        أنشئ قصة جديدة
                    </span>
                </button>
                <button id="reset-progress-btn" class="mt-4 bg-red-500 text-white px-4 py-2 rounded-md text-sm hover:bg-red-600 transition">إعادة تعيين التقدم</button>
            </div>

            <div id="alphabet-screen" class="hidden p-4 bg-white rounded-lg shadow-md"></div>
            
            <div id="history-screen" class="hidden p-4 bg-white rounded-lg shadow-md space-y-3">
                <h2 class="text-2xl font-bold mb-4 text-center">الدروس السابقة</h2>
                <div id="history-list" class="space-y-2"></div>
            </div>

            <div id="learned-words-screen" class="hidden p-4 bg-white rounded-lg shadow-md"></div>
            
            <div id="basket-screen" class="hidden space-y-6"></div>

            <div id="loading-screen" class="hidden text-center p-8 bg-white rounded-lg shadow-md">
                <div class="flex justify-center mb-4"><div class="loader"></div></div>
                <p class="text-slate-600 text-lg">الذكاء الاصطناعي يعمل... يرجى الانتظار.</p>
            </div>

            <div id="lesson-screen" class="hidden space-y-6"></div>
        </main>

        <div id="selection-popup" class="hidden absolute bg-white border rounded-lg shadow-xl p-1 flex gap-1 z-50">
            <button id="popup-translate" title="ترجمة" class="p-2 hover:bg-slate-100 rounded-md">🇵🇰</button>
            <button id="popup-speak" title="نطق" class="p-2 hover:bg-slate-100 rounded-md">🔊</button>
            <button id="popup-phonetics" title="كتابة صوتية" class="p-2 hover:bg-slate-100 rounded-md">🗣️</button>
            <button id="popup-save" title="حفظ للسلة" class="p-2 hover:bg-slate-100 rounded-md">💾</button>
        </div>
    </div>

    <script>
        const urduAlphabet = ['ا', 'ب', 'پ', 'ت', 'ٹ', 'ث', 'ج', 'چ', 'ح', 'خ', 'د', 'ڈ', 'ذ', 'ر', 'ڑ', 'ز', 'ژ', 'س', 'ش', 'ص', 'ض', 'ط', 'ظ', 'ع', 'غ', 'ف', 'ق', 'ک', 'گ', 'ل', 'م', 'ن', 'ں', 'و', 'ہ', 'ھ', 'ء', 'ی', 'ے'];
        const a1UrduWords = [
            'میں', 'تم', 'آپ', 'یہ', 'وہ', 'ہم', 'کون', 'کیا', 'کہاں', 'کب', 'کیسے', 'کیوں', 'میرا', 'تمہارا', 'آپکا', 'اسکا', 'ہمارا', 'انکا', 'کوئی', 'سب', 'ہر کوئی',
            'آدمی', 'عورت', 'لڑکا', 'لڑکی', 'بچہ', 'بچے', 'دوست', 'دشمن', 'خاندان', 'والد', 'والدہ', 'ماں', 'باپ', 'بھائی', 'بہن', 'شوہر', 'بیوی', 'بیٹا', 'بیٹی', 'لوگ', 'رشتے دار',
            'دادا', 'دادی', 'نانا', 'نانی', 'پوتا', 'پوتی', 'نواسہ', 'نواسی', 'چچا', 'چچی', 'ماموں', 'ممانی', 'خالہ', 'خالو', 'پھوپھا', 'پھوپھی',
            'استاد', 'طالب علم', 'ڈاکٹر', 'مریض', 'انجینئر', 'وکیل', 'جج', 'کسان', 'دکاندار', 'گاہک', 'باورچی', 'ڈرائیور', 'پائلٹ', 'فوجی', 'پولیس', 'مصور', 'گلوکار', 'اداکار', 'کھلاڑی', 'سائنسدان', 'مزدور', 'ملازم', 'افسر', 'حکمران', 'وزیر', 'صدر', 'بادشاہ', 'ملکہ', 'شہزادہ', 'شہزادی',
            'صفر', 'ایک', 'دو', 'تین', 'چار', 'پانچ', 'چھ', 'سات', 'آٹھ', 'نو', 'دس', 'گیارہ', 'بارہ', 'تیرہ', 'چودہ', 'پندرہ', 'سولہ', 'سترہ', 'اٹھارہ', 'انیس', 'بیس', 'اکیس', 'تیس', 'چالیس', 'پچاس', 'ساٹھ', 'ستر', 'اسی', 'نوے', 'سو', 'دو سو', 'ہزار', 'دس ہزار', 'لاکھ', 'کروڑ', 'پہلا', 'دوسرا', 'تیسرا', 'آخری', 'آدھا', 'پورا',
            'گھر', 'مکان', 'کمرہ', 'باورچی خانہ', 'غسل خانہ', 'دیوان خانہ', 'چھت', 'صحن', 'اسکول', 'کالج', 'یونیورسٹی', 'کتب خانہ', 'دفتر', 'بازار', 'دکان', 'ہسپتال', 'کلینک', 'باغ', 'پارک', 'کھیل کا میدان', 'شہر', 'گاؤں', 'قصبہ', 'ملک', 'صوبہ', 'دارالحکومت', 'دنیا', 'مسجد', 'مندر', 'گرجا', 'سڑک', 'گلی', 'چوک', 'ہوٹل', 'ریسٹورنٹ', 'بینک', 'ائیرپورٹ', 'اسٹیشن', 'بس اسٹاپ', 'عجائب گھر', 'چڑیا گھر', 'فیکٹری', 'کارخانہ', 'کھیت',
            'پانی', 'کھانا', 'چائے', 'کافی', 'دودھ', 'دہی', 'لسی', 'جوس', 'شربت', 'روٹی', 'چاول', 'سالن', 'سبزی', 'پھل', 'سیب', 'کیلا', 'آم', 'سنترا', 'امرود', 'تربوز', 'انگور', 'گوشت', 'مرغی', 'مچھلی', 'انڈا', 'چینی', 'نمک', 'مرچ', 'ہلدی', 'مسالا', 'گھی', 'تیل', 'مکھن', 'پنیر', 'ناشتہ', 'دوپہر کا کھانا', 'رات کا کھانا', 'آٹا', 'دال', 'پیاز', 'ٹماٹر', 'آلو', 'لہسن', 'ادرک', 'مٹھائی', 'کیک', 'بسکٹ',
            'کتاب', 'قلم', 'پنسل', 'کاپی', 'کاغذ', 'خط', 'لفافہ', 'میز', 'کرسی', 'دروازہ', 'کھڑکی', 'گاڑی', 'بس', 'سائیکل', 'موٹر سائیکل', 'جہاز', 'ٹرین', 'کشتی', 'پیسے', 'سکہ', 'نوٹ', 'رنگ', 'تصویر', 'فون', 'موبائل', 'کمپیوٹر', 'لیپ ٹاپ', 'ٹی وی', 'ریڈیو', 'گھڑی', 'چابی', 'تالا', 'بستر', 'تکیہ', 'کمبل', 'چادر', 'کپڑے', 'قمیض', 'پتلون', 'شلوار', 'جوتا', 'چپل', 'موزے', 'ٹوپی', 'بیگ', 'بستہ', 'صابن', 'شیمپو', 'تولیہ', 'شیشہ', 'آئینہ', 'کنگھی', 'اخبار', 'رسالہ', 'کہانی', 'نظم', 'تحفہ', 'اوزار', 'ہتھیار', 'بندوق', 'تلوار', 'چھری', 'چمچ', 'کانٹا', 'پلیٹ', 'گلاس', 'پیالی', 'دیگچی',
            'وقت', 'دن', 'رات', 'آج', 'کل', 'پرسوں', 'صبح', 'دوپہر', 'سہ پہر', 'شام', 'آدھی رات', 'منٹ', 'سیکنڈ', 'گھنٹہ', 'ہفتہ', 'مہینہ', 'سال', 'صدی', 'تاریخ', 'اتوار', 'پیر', 'منگل', 'بدھ', 'جمعرات', 'جمعہ', 'ہفتہ', 'جنوری', 'فروری', 'مارچ', 'اپریل', 'مئی', 'جون', 'جولائی', 'اگست', 'ستمبر', 'اکتوبر', 'نومبر', 'دسمبر',
            'نام', 'کام', 'بات', 'زبان', 'اردو', 'انگریزی', 'مطلب', 'معنی', 'سوال', 'جواب', 'مدد', 'ضرورت', 'خواہش', 'پیار', 'محبت', 'عشق', 'نفرت', 'خوشی', 'غم', 'غصہ', 'ڈر', 'خوف', 'امید', 'یقین', 'شک', 'زندگی', 'موت', 'شادی', 'طلاق', 'جشن', 'موسم', 'گرمی', 'سردی', 'بہار', 'خزاں', 'بارش', 'برف', 'طوفان', 'ہوا', 'آگ', 'آواز', 'شور', 'خاموشی', 'روشنی', 'اندھیرا', 'سچ', 'جھوٹ', 'خواب', 'حقیقت', 'علم', 'جہالت', 'انصاف', 'ظلم', 'آزادی', 'غلامی', 'صحت', 'بیماری', 'کامیابی', 'ناکامی', 'امن', 'جنگ', 'مذہب', 'اسلام', 'قانون', 'سیاست', 'تاریخ', 'جغرافیہ', 'سائنس', 'فن', 'موسیقی', 'کھیل', 'قسمت', 'موقع', 'غلطی', 'خیال', 'سوچ', 'وجہ', 'نتیجہ', 'فرق', 'شکل', 'سائز',
            'اچھا', 'برا', 'بڑا', 'چھوٹا', 'نیا', 'پرانا', 'خوبصورت', 'بدصورت', 'لمبا', 'پست قد', 'موٹا', 'پتلا', 'دبلا', 'گرم', 'ٹھنڈا', 'خوش', 'اداس', 'ناراض', 'بیمار', 'صحت مند', 'امیر', 'غریب', 'آسان', 'مشکل', 'کٹھن', 'صحیح', 'غلط', 'صاف', 'گندا', 'خالی', 'بھرا', 'تیز', 'آہستہ', 'مضبوط', 'کمزور', 'سستا', 'مہنگا', 'میٹھا', 'کڑوا', 'نمکین', 'پھیکا', 'تیار', 'مصروف', 'فارغ', 'زندہ', 'مردہ', 'اکیلا', 'شادی شدہ', 'کنوارہ', 'ذہین', 'بیوقوف', 'بہادر', 'بزدل', 'ایماندار', 'بے ایمان', 'محنتی', 'سست', 'کاہل', 'دلچسپ', 'بورنگ', 'ضروری', 'غیر ضروری', 'خاص', 'عام', 'مشہور', 'گمنام', 'تازہ', 'باسی', 'گہرا', 'ہلکا', 'گیلا', 'خشک', 'سخت', 'نرم', 'سیدھا', 'ٹیڑھا', 'گول', 'چوکور', 'پاگل', 'عقلمند',
            'جسم', 'سر', 'بال', 'چہرہ', 'آنکھ', 'ناک', 'منہ', 'زبان', 'دانت', 'ہونٹ', 'کان', 'گردن', 'کندھا', 'ہاتھ', 'بازو', 'انگلی', 'ناخن', 'سینہ', 'پیٹ', 'کمر', 'پاؤں', 'ٹانگ', 'گھٹنا', 'دل', 'دماغ', 'خون', 'ہڈی', 'جلد',
            'آسمان', 'سورج', 'چاند', 'ستارہ', 'زمین', 'دریا', 'ندی', 'سمندر', 'جھیل', 'پہاڑ', 'چٹان', 'جنگل', 'صحرا', 'میدان', 'جانور', 'پرندہ', 'шیر', 'چیتا', 'ہاتھی', 'گھوڑا', 'کتا', 'بلی', 'گائے', 'بھینس', 'بکری', 'سانپ', 'مور', 'طوطا', 'کبوتر', 'پھول', 'گلاب', 'درخت', 'پودا', 'پتا', 'گھاس',
            'سرخ', 'لال', 'نیلا', 'پیلا', 'سبز', 'کالا', 'سفید', 'گلابی', 'نارنجی', 'جامنی', 'بھورا', 'سرمئی', 'سنہرا', 'چاندی',
            'ہونا', 'کرنا', 'جانا', 'آنا', 'دیکھنا', 'بولنا', 'کہنا', 'سننا', 'پڑھنا', 'لکھنا', 'سونا', 'جاگنا', 'اٹھنا', 'بیٹھنا', 'کھڑا ہونا', 'چلنا', 'دوڑنا', 'اڑنا', 'تیرنا', 'پینا', 'کھانا', 'پکانا', 'رکھنا', 'اٹھانا', 'دینا', 'لینا', 'چاہنا', 'پسند کرنا', 'نفرت کرنا', 'سمجھنا', 'سمجھانا', 'پوچھنا', 'بتانا', 'کام کرنا', 'کھیلنا', 'لڑنا', 'ہنسنا', 'رونا', 'مسکرانا', 'ملنا', 'ملانا', 'خریدنا', 'بیچنا', 'پہننا', 'اتارنا', 'کھولنا', 'بند کرنا', 'شروع کرنا', 'ختم کرنا', 'انتظار کرنا', 'یاد کرنا', 'بھولنا', 'سکھانا', 'سیکھنا', 'رہنا', 'مرنا', 'پیدا ہونا', 'بنانا', 'بگاڑنا', 'سوچنا', 'کوشش کرنا', 'مدد کرنا', 'دھونا', 'صاف کرنا', 'گرنا', 'پکڑنا', 'چھوڑنا', 'ڈھونڈنا', 'کھونا', 'بھیجنا', 'وصول کرنا', 'توڑنا', 'جوڑنا', 'جیتنا', 'ہارنا', 'ڈرنا', 'ڈالنا', 'نکالنا', 'چڑھنا', 'اترنا', 'داخل ہونا', 'باہر نکلنا', 'پہنچنا', 'بتانا', 'پکارنا', 'چلانا',
            'بہت', 'کم', 'تھوڑا', 'زیادہ', 'صرف', 'بھی', 'ہی', 'یہاں', 'وہاں', 'جدھر', 'ادھر', 'اب', 'ابھی', 'تب', 'جب', 'کب', 'پھر', 'جلدی', 'آہستہ', 'آرام سے', 'تیزی سے', 'زور سے', 'اوپر', 'نیچے', 'اندر', 'باہر', 'آگے', 'پیچھے', 'ساتھ', 'اکیلے', 'پاس', 'نزدیک', 'دور', 'پہلے', 'بعد میں', 'ہمیشہ', 'اکثر', 'کبھی کبھی', 'کبھی نہیں', 'شاید', 'یقیناً', 'ضرور', 'بلکل', 'تقریباً', 'خاص طور پر',
            'میں', 'پر', 'سے', 'تک', 'کو', 'کا', 'کی', 'کے', 'لیے', 'کی طرف', 'کے بارے میں', 'کے ساتھ', 'کے بغیر', 'کے نیچے', 'کے اوپر', 'کے سامنے', 'کے پیچھے', 'کے اندر', 'کے باہر',
            'اور', 'لیکن', 'مگر', 'پر', 'یا', 'تو', 'پھر', 'کیونکہ', 'اس لیے', 'تاکہ', 'اگر', 'جبکہ', 'حالانکہ', 'کہ',
            'ہاں', 'جی', 'نہیں', 'جی نہیں', 'ٹھیک ہے', 'بہت اچھا', 'شکریہ', 'مہربانی', 'خوش آمدید', 'معاف کیجئے', 'کوئی بات نہیں', 'السلام علیکم', 'وعلیکم السلام', 'خدا حافظ', 'اللہ حافظ', 'صبح بخیر', 'شام بخیر', 'شب بخیر', 'الوداع', 'مبارک ہو', 'افسوس', 'شاباش', 'ارے', 'اوہ', 'اف',
            'میرا نام علی ہے', 'آپ کیسے ہیں', 'میں ٹھیک ہوں', 'آپ کا نام کیا ہے', 'آپ کہاں سے ہیں', 'وقت کیا ہوا ہے', 'یہ کتنے کا ہے', 'مجھے یہ چاہیے', 'مجھے نہیں معلوم', 'کیا آپ میری مدد کر سکتے ہیں', 'مجھے بھوک لگی ہے', 'مجھے پیاس لگی ہے'
        ];
        const ttsVoices = ['Zephyr', 'Puck', 'Charon', 'Kore', 'Fenrir', 'Leda', 'Orus', 'Aoede', 'Callirrhoe', 'Autonoe', 'Enceladus', 'Iapetus', 'Umbriel', 'Algieba', 'Despina', 'Erinome', 'Algenib', 'Rasalgethi', 'Laomedeia', 'Achernar', 'Alnilam', 'Schedar', 'Gacrux', 'Pulcherrima', 'Achird', 'Zubenelgenubi', 'Vindemiatrix', 'Sadachbia', 'Sadaltager', 'Sulafat'];

        const allDOMElements = {
            apiKeySection: document.getElementById('api-key-section'),
            apiKeyInput: document.getElementById('api-key-input'),
            saveApiKeyBtn: document.getElementById('save-api-key-btn'),
            mainContent: document.getElementById('main-content'),
            navHome: document.getElementById('nav-home'),
            navAlphabet: document.getElementById('nav-alphabet'),
            navHistory: document.getElementById('nav-history'),
            navLearned: document.getElementById('nav-learned'),
            navBasket: document.getElementById('nav-basket'),
            homeScreen: document.getElementById('home-screen'),
            alphabetScreen: document.getElementById('alphabet-screen'),
            historyScreen: document.getElementById('history-screen'),
            learnedWordsScreen: document.getElementById('learned-words-screen'),
            basketScreen: document.getElementById('basket-screen'),
            historyList: document.getElementById('history-list'),
            statsSection: document.getElementById('stats-section'),
            totalWordsEl: document.getElementById('total-words'),
            learnedWordsEl: document.getElementById('learned-words'),
            remainingWordsEl: document.getElementById('remaining-words'),
            newLessonBtn: document.getElementById('new-lesson-btn'),
            resetProgressBtn: document.getElementById('reset-progress-btn'),
            loadingScreen: document.getElementById('loading-screen'),
            lessonScreen: document.getElementById('lesson-screen'),
            selectionPopup: document.getElementById('selection-popup'),
        };

        let apiKey = '';
        let learnedWords = [];
        let learningBasket = [];
        let lessonHistory = [];
        let remainingWords = [...a1UrduWords];
        let audioContext;
        let isLessonActive = false;
        let selectionTimeout;
        let isDragging = false;

        function initialize() {
            try {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            } catch (e) {
                console.error("Web Audio API is not supported in this browser");
                showModal("متصفحك لا يدعم تشغيل الصوتيات، قد لا تعمل بعض الميزات.");
            }

            loadState();
            updateProgress();
            setupEventListeners();
        }

        function setupEventListeners() {
            allDOMElements.saveApiKeyBtn.addEventListener('click', handleSaveApiKey);
            allDOMElements.apiKeyInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') handleSaveApiKey(); });
            allDOMElements.newLessonBtn.addEventListener('click', handleNewLesson);
            allDOMElements.resetProgressBtn.addEventListener('click', handleResetProgress);
            allDOMElements.navHome.addEventListener('click', () => showTab('home'));
            allDOMElements.navAlphabet.addEventListener('click', () => showTab('alphabet'));
            allDOMElements.navHistory.addEventListener('click', () => showTab('history'));
            allDOMElements.navLearned.addEventListener('click', () => showTab('learned'));
            allDOMElements.navBasket.addEventListener('click', () => showTab('basket'));
            
            // Hybrid interaction model
            const lessonArea = allDOMElements.lessonScreen;
            lessonArea.addEventListener('mousedown', () => { isDragging = false; });
            lessonArea.addEventListener('mousemove', () => { isDragging = true; });
            lessonArea.addEventListener('mouseup', handleInteractionEnd);
            
            // For mobile
            lessonArea.addEventListener('touchstart', () => { isDragging = false; }, { passive: true });
            lessonArea.addEventListener('touchmove', () => { isDragging = true; }, { passive: true });
            lessonArea.addEventListener('touchend', handleInteractionEnd);
            
            document.addEventListener('click', (e) => {
                if (!allDOMElements.selectionPopup.contains(e.target)) {
                    allDOMElements.selectionPopup.classList.add('hidden');
                }
            });

            // Resume audio context on first user interaction
            document.body.addEventListener('click', resumeAudioContext, { once: true });
            document.body.addEventListener('touchend', resumeAudioContext, { once: true });
        }
        
        function handleInteractionEnd(event) {
            const selection = window.getSelection();
            const selectedText = selection.toString().trim();

            // Case 1: It was a drag-selection of a phrase
            if (isDragging && selectedText.length > 0) {
                event.preventDefault(); // Prevent click event from firing after drag
                showSelectionPopup(selection);
            }
            // Case 2: It was a simple click/tap on a single word
            else if (!isDragging && event.target.closest('.word-span, b')) {
                const target = event.target.closest('.word-span, b');
                const text = target.textContent.trim().replace(/[.,!?;:]/g, '');
                if (text) {
                    showWordActionModal(text);
                }
            }
            isDragging = false;
        }

        function showSelectionPopup(selection) {
            const selectedText = selection.toString().trim();
            if (!selectedText) return;

            const range = selection.getRangeAt(0);
            const rect = range.getBoundingClientRect();
            const popup = allDOMElements.selectionPopup;
            
            popup.style.left = `${rect.left + window.scrollX + (rect.width / 2) - (popup.offsetWidth / 2)}px`;
            popup.style.top = `${rect.top + window.scrollY - popup.offsetHeight - 10}px`;
            popup.classList.remove('hidden');

            const mood = document.getElementById('story-container')?.dataset.mood || 'neutral';

            popup.querySelector('#popup-translate').onclick = () => { getTranslation(selectedText).then(res => res && showModal(`<p class="text-xl font-bold text-sky-600">${res}</p>`, `ترجمة: <span class="font-urdu text-xl">${selectedText}</span>`)); popup.classList.add('hidden'); };
            popup.querySelector('#popup-speak').onclick = () => { speakText(selectedText, mood); }; // Don't hide popup
            popup.querySelector('#popup-phonetics').onclick = () => { getPhonetics(selectedText).then(res => res && showModal(`<p class="text-xl font-bold text-sky-600">${res}</p>`, `النطق التقريبي لـ: <span class="font-urdu text-xl">${selectedText}</span>`)); popup.classList.add('hidden'); };
            popup.querySelector('#popup-save').onclick = () => { saveToBasket(selectedText); popup.classList.add('hidden'); };
        }


        function resumeAudioContext() {
            if (audioContext && audioContext.state === 'suspended') {
                audioContext.resume();
            }
        }

        async function showWordActionModal(text) {
            const mood = document.getElementById('story-container')?.dataset.mood || 'neutral';
            
            const modalTitle = `<span class="font-urdu text-3xl">${text}</span>`;
            const modalContent = `<p class="text-slate-600">اختر الإجراء الذي تريده لهذه الكلمة.</p>`;

            const actions = [
                {
                    text: '🇵🇰 ترجمة',
                    class: 'action-translate-btn bg-blue-500 text-white',
                    callback: async () => {
                        const translation = await getTranslation(text);
                        if (translation) {
                           showModal(`<p class="text-xl font-bold text-sky-600">${translation}</p>`, `ترجمة: <span class="font-urdu text-xl">${text}</span>`);
                        }
                    }
                },
                {
                    text: '🔊 نطق',
                    class: 'action-speak-btn bg-green-500 text-white',
                    callback: () => speakText(text, mood),
                    keepOpen: true
                },
                {
                    text: '🗣️ كتابة صوتية',
                    class: 'action-phonetics-btn bg-purple-500 text-white',
                    callback: async () => {
                        const phonetics = await getPhonetics(text);
                        if (phonetics) {
                            showModal(`<p class="text-xl font-bold text-sky-600">${phonetics}</p>`, `النطق التقريبي لـ: <span class="font-urdu text-xl">${text}</span>`);
                        }
                    }
                },
                {
                    text: '💾 حفظ للسلة',
                    class: 'action-save-btn bg-amber-500 text-white',
                    callback: () => saveToBasket(text)
                }
            ];

            showModal(modalContent, modalTitle, actions);
        }

        function loadState() {
            apiKey = localStorage.getItem('geminiApiKey_ur') || '';
            learnedWords = JSON.parse(localStorage.getItem('learnedWords_ur')) || [];
            learningBasket = JSON.parse(localStorage.getItem('learningBasket_ur')) || [];
            lessonHistory = JSON.parse(localStorage.getItem('lessonHistory_ur')) || [];

            if (apiKey) {
                allDOMElements.apiKeyInput.value = apiKey;
                allDOMElements.apiKeySection.classList.add('hidden');
                allDOMElements.mainContent.classList.remove('hidden');
            }
        }

        function saveState() {
            localStorage.setItem('learnedWords_ur', JSON.stringify(learnedWords));
            localStorage.setItem('learningBasket_ur', JSON.stringify(learningBasket));
            localStorage.setItem('lessonHistory_ur', JSON.stringify(lessonHistory));
        }

        function updateProgress() {
            remainingWords = a1UrduWords.filter(word => !learnedWords.includes(word));
            allDOMElements.totalWordsEl.textContent = a1UrduWords.length;
            allDOMElements.learnedWordsEl.textContent = learnedWords.length;
            allDOMElements.remainingWordsEl.textContent = remainingWords.length;
        }

        function showScreen(screen) {
            const screens = [
                allDOMElements.homeScreen, allDOMElements.alphabetScreen, allDOMElements.historyScreen,
                allDOMElements.learnedWordsScreen, allDOMElements.basketScreen, allDOMElements.loadingScreen,
                allDOMElements.lessonScreen
            ];
            screens.forEach(s => s.classList.add('hidden'));
            if (screen) screen.classList.remove('hidden');
        }

        function showTab(tabName) {
            showScreen(null);
            const navs = [allDOMElements.navHome, allDOMElements.navAlphabet, allDOMElements.navHistory, allDOMElements.navLearned, allDOMElements.navBasket];
            navs.forEach(nav => {
                nav.classList.remove('border-sky-600', 'text-sky-600');
                nav.classList.add('border-transparent', 'text-slate-500');
            });

            const activeNav = document.getElementById(`nav-${tabName}`);
            if (activeNav) {
                activeNav.classList.remove('border-transparent', 'text-slate-500');
                activeNav.classList.add('border-sky-600', 'text-sky-600');
            }

            if (tabName === 'home') {
                showScreen(isLessonActive ? allDOMElements.lessonScreen : allDOMElements.homeScreen);
            } else if (tabName === 'alphabet') {
                renderAlphabetScreen();
                showScreen(allDOMElements.alphabetScreen);
            } else if (tabName === 'history') {
                renderHistory();
                showScreen(allDOMElements.historyScreen);
            } else if (tabName === 'learned') {
                renderLearnedWords();
                showScreen(allDOMElements.learnedWordsScreen);
            } else if (tabName === 'basket') {
                renderBasket();
                showScreen(allDOMElements.basketScreen);
            }
        }

        function showModal(content, title = 'تنبيه', actions = []) {
            const existingModal = document.querySelector('.modal-overlay');
            if (existingModal) existingModal.remove();
            
            const actionsHtml = actions.map(action => 
                `<button class="${action.class} px-4 py-2 rounded-md transition">${action.text}</button>`
            ).join('');

            const modalOverlay = document.createElement('div');
            modalOverlay.className = 'modal-overlay';
            modalOverlay.innerHTML = `
                <div class="modal-content">
                    <h3 class="text-xl font-bold mb-4">${title}</h3>
                    <div>${content}</div>
                    <div class="mt-6 flex gap-3 justify-center flex-wrap">
                        ${actionsHtml}
                        <button class="modal-close bg-slate-500 text-white px-6 py-2 rounded-md hover:bg-slate-600">إغلاق</button>
                    </div>
                </div>`;
            document.body.appendChild(modalOverlay);
            
            modalOverlay.addEventListener('click', (e) => {
                if (e.target.classList.contains('modal-close') || e.target === modalOverlay) {
                    modalOverlay.remove();
                }
                actions.forEach((action) => {
                    const buttonClass = action.class.split(' ')[0];
                    if (e.target.classList.contains(buttonClass)) {
                        action.callback();
                        if (!action.keepOpen) { 
                            modalOverlay.remove();
                        }
                    }
                });
            });
        }
        
        function selectNewWords() {
            const count = Math.floor(Math.random() * 6) + 15; // 15 to 20 words
            const shuffled = remainingWords.sort(() => 0.5 - Math.random());
            return shuffled.slice(0, count);
        }

        async function generateLesson(words, rewrite = false, isRevision = false) {
            if (!apiKey) {
                showModal('الرجاء حفظ مفتاح Gemini API أولاً.');
                return;
            }
            isLessonActive = false;
            showScreen(allDOMElements.loadingScreen);

            const prompt = `
            You are an expert Urdu teacher for absolute beginners (A1 level) who speak Arabic. Your task is to create a lesson in URDU using these words: ${words.join(', ')}.

            **EXTREMELY IMPORTANT RULES:**
            1.  **A1 Level ONLY:** You MUST use ONLY very simple Urdu words and grammar. The grammar and sentence structure must also be strictly A1 level.
            2.  **SIMPLE SENTENCES:** Use very simple sentences. For example: "یہ ایک کتاب ہے" or "علی اسکول جاتا ہے".
            3.  **DO NOT USE:** Complex sentences, advanced tenses, or difficult vocabulary. Stick to the Present Simple tense.
            4.  **DIVERSIFY CONTENT:** Randomly choose one style for the main text:
                * **Story (کہانی):** A simple third-person narrative.
                * **Dialogue (مکالمہ):** A conversation between two people (use common Urdu names like "علی", "فاطمہ"). Format as: "علی: السلام علیکم\\nفاطمہ: وعلیکم السلام".
                * **Narrative (بیانیہ):** A simple first-person narrative ("میں ایک طالب علم ہوں...").
            5.  **JSON FORMAT:** The entire response must be a single, valid JSON object with no extra text. All explanations and translations must be in ARABIC.
            6.  **EXERCISES:** The "question" text must be plain text without any markdown like **. The questions should be in Urdu.

            ${rewrite ? 'أعد كتابة القصة والتمارين فقط بنفس الكلمات والقواعد السابقة، مع تغيير الأسلوب (قصة، حوار، سرد).' : 'قم بإنشاء درس جديد بالكامل.'}

            **Required JSON Structure (text in "quotes" must be in Urdu, explanations in Arabic):**
            {
              "story_type": "kahani, mukalma, or bayania",
              "story_mood": "صفة واحدة بالإنجليزية تصف الحالة المزاجية للقصة (e.g., happy, calm, neutral)",
              "story": "النص الأساسي بالأردية من 4-5 أسطر. قم بتمييز الكلمات المستهدفة بوسوم <b></b>.",
              "new_words": [{"word": "الكلمة الأردية", "translation": "ترجمتها بالعربية"}],
              "grammar_focus": {
                "title": "عنوان القاعدة النحوية (بالعربية)",
                "explanation": "شرح مطول ومفصل للقاعدة بالعربية مع سياقها وكيف ظهرت في النص.",
                "examples": [
                  {"example": "جملة مثال بالأردية", "translation": "ترجمة المثال بالعربية"}
                ]
              },
              "useful_structures": [
                {"structure": "التركيب من القصة بالأردية", "explanation": "شرح استخدامه ومعناه بالعربية"}
              ],
              "pronunciation_tips": {
                  "title": "نصائح للنطق (بالعربية)",
                  "tips": [
                      {"context": "الكلمة أو الحرف بالأردية", "tip": "نصيحة النطق بالعربية"}
                  ]
              },
              "exercises": [
                {"type": "fill_in_the_blank", "question": "سؤال املأ الفراغ بالأردية مع ___.", "answer": "الكلمة الصحيحة بالأردية"},
                {"type": "multiple_choice", "question": "سؤال اختيار من متعدد بالأردية.", "options": ["خيار أ", "خيار ب", "خيار ج"], "answer": "الإجابة الصحيحة بالأردية"},
                {"type": "true_false", "question": "جملة للحكم عليها بالأردية.", "answer": "false"}
              ]
            }
            `;

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });

                if (!response.ok) throw new Error(`API Error: ${response.status}`);
                const result = await response.json();
                const text = result.candidates[0].content.parts[0].text;
                const jsonString = text.replace(/```json/g, '').replace(/```/g, '').trim();
                const lessonData = JSON.parse(jsonString);
                
                if (!rewrite && !isRevision) {
                    learnedWords.push(...words);
                    lessonData.learnedWords = words;
                    lessonData.date = new Date().toLocaleString('ar-EG');
                    lessonHistory.unshift(lessonData);
                    if (lessonHistory.length > 20) lessonHistory.pop();
                    saveState();
                    updateProgress();
                }
                
                renderLesson(lessonData, isRevision);
                isLessonActive = true;
                showScreen(allDOMElements.lessonScreen);

            } catch (error) {
                console.error('Error generating lesson:', error);
                showModal('حدث خطأ أثناء إنشاء الدرس. تأكد من صحة مفتاح API أو جرب مرة أخرى.');
                showScreen(allDOMElements.homeScreen);
            }
        }
        
        function createSection(title, content, titleControls = '') {
            return `
                <div class="p-5 bg-white rounded-lg shadow-md">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-bold text-sky-700">${title}</h3>
                        <div>${titleControls}</div>
                    </div>
                    ${content}
                </div>
            `;
        }

        function renderLesson(data, isRevision = false) {
            const lessonTitle = isRevision ? 'مراجعة النص' : '1. النص';
            const wordsTitle = isRevision ? 'كلمات للمراجعة' : '2. الكلمات الجديدة';

            const storyControls = `
                <button id="read-story-btn" title="قراءة النص كاملاً" class="p-2 hover:bg-slate-200 rounded-full transition">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-sky-600"><polygon points="11 5 6 9 2 9 2 15 6 15 11 19 11 5"></polygon><path d="M15.54 8.46a5 5 0 0 1 0 7.07"></path></svg>
                </button>
            `;

            const storyContent = `
                <div id="story-container" class="text-2xl font-urdu lesson-content" data-mood="${data.story_mood || 'neutral'}">
                    ${formatStory(data.story, data.story_type)}
                </div>
                <div class="flex items-center justify-center gap-4 mt-4 pt-4 border-t">
                    <label for="line-height-slider" class="text-sm text-slate-600">تباعد الأسطر:</label>
                    <input type="range" id="line-height-slider" min="1.5" max="4" step="0.1" value="2.8" class="w-40 cursor-pointer">
                </div>
            `;

            allDOMElements.lessonScreen.innerHTML = `
                ${createSection(lessonTitle, storyContent, storyControls)}
                ${createSection(wordsTitle, createTable(data.new_words, ['الكلمة', 'المعنى'], 'word', 'translation'))}
                ${createSection('3. قواعد نستفيدها', renderGrammarSection(data.grammar_focus))}
                ${createSection('4. تراكيب مفيدة', createTable(data.useful_structures, ['التركيب', 'الاستخدام'], 'structure', 'explanation'))}
                ${createSection(data.pronunciation_tips.title || '5. نصائح للنطق', renderPronunciationTips(data.pronunciation_tips))}
                ${createSection('6. تمارين', renderExercises(data.exercises))}
                <div class="flex flex-col sm:flex-row gap-4 justify-center mt-8">
                    <button id="rewrite-btn" class="bg-amber-500 text-white px-6 py-2 rounded-md hover:bg-amber-600 transition">أعد كتابة القصة بنفس الكلمات</button>
                    <button id="next-lesson-btn" class="bg-sky-600 text-white px-6 py-2 rounded-md hover:bg-sky-700 transition">درس جديد بكلمات جديدة</button>
                </div>
            `;
            
            const slider = document.getElementById('line-height-slider');
            const storyContainer = document.getElementById('story-container');
            
            storyContainer.style.lineHeight = slider.value;
            slider.addEventListener('input', (e) => {
                storyContainer.style.lineHeight = e.target.value;
            });

            document.getElementById('read-story-btn').addEventListener('click', () => {
                const storyText = storyContainer.textContent.trim();
                if (storyText) speakText(storyText);
            });

            document.getElementById('rewrite-btn').addEventListener('click', () => generateLesson(data.learnedWords || data.new_words.map(w => w.word), true, isRevision));
            document.getElementById('next-lesson-btn').addEventListener('click', handleNewLesson);
            document.getElementById('check-answers-btn').addEventListener('click', checkAnswers);
        }
        
        function wrapWordsInSpans(htmlContent) {
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = htmlContent;
            
            const walker = document.createTreeWalker(tempDiv, NodeFilter.SHOW_TEXT, null, false);
            let node;
            const textNodes = [];
            while(node = walker.nextNode()) {
                if (node.parentNode.tagName !== 'B' && node.parentNode.tagName !== 'SPAN') {
                     textNodes.push(node);
                }
            }

            textNodes.forEach(node => {
                const parent = node.parentNode;
                const words = node.nodeValue.split(/(\s+)/);
                const fragment = document.createDocumentFragment();
                words.forEach(word => {
                    if (word.trim().length > 0) {
                        const span = document.createElement('span');
                        span.className = 'word-span';
                        span.textContent = word;
                        fragment.appendChild(span);
                    } else {
                        fragment.appendChild(document.createTextNode(word));
                    }
                });
                parent.replaceChild(fragment, node);
            });

            return tempDiv.innerHTML;
        }

        function renderGrammarSection(grammar) {
            if (!grammar) return '<p>لا توجد ملاحظات نحوية لهذا الدرس.</p>';
            let html = `
                <h4 class="font-bold text-lg mb-2">${grammar.title}</h4>
                <p class="text-slate-600/90 mb-4">${grammar.explanation}</p>
            `;
            if (grammar.examples && grammar.examples.length > 0) {
                html += createTable(grammar.examples, ['المثال', 'الترجمة'], 'example', 'translation');
            }
            return html;
        }

        function renderPronunciationTips(pronunciation) {
            if (!pronunciation || !pronunciation.tips || pronunciation.tips.length === 0) return '<p>لا توجد نصائح نطق لهذا الدرس.</p>';
            return createTable(pronunciation.tips, ['الكلمة/الحرف', 'النصيحة'], 'context', 'tip');
        }

        function formatStory(story, type) {
            const wrappedStory = wrapWordsInSpans(story);
            if (type !== 'mukalma') return wrappedStory;
            
            const speakers = [];
            const lines = wrappedStory.split(/\n|<br>|<br\/>/g);
            return lines.map(line => {
                if (!line.trim()) return '';
                const match = line.match(/^(.*?):/);
                if (match) {
                    let speaker = match[1].replace(/<[^>]*>?/gm, '').trim();
                    let speakerClass = 'dialogue-speaker-1';
                    if (!speakers.includes(speaker)) speakers.push(speaker);
                    if (speakers.indexOf(speaker) % 2 !== 0) speakerClass = 'dialogue-speaker-2';
                    
                    const restOfLine = line.substring(match[0].length);
                    return `<div class="dialogue-line"><span class="${speakerClass}">${speaker}:</span>${restOfLine}</div>`;
                }
                return `<div class="dialogue-line">${line}</div>`;
            }).join('');
        }

        function createTable(data, headers, key1, key2) {
            let tableHTML = '<div class="overflow-x-auto"><table class="table-style">';
            tableHTML += `<thead><tr><th>${headers[0]}</th><th>${headers[1]}</th></tr></thead>`;
            tableHTML += '<tbody>';
            data.forEach(item => {
                tableHTML += `<tr><td class="font-urdu text-lg">${item[key1]}</td><td>${item[key2]}</td></tr>`;
            });
            tableHTML += '</tbody></table></div>';
            return tableHTML;
        }

        function renderExercises(exercises) {
            let html = '<div class="space-y-4">';
            exercises.forEach((ex, index) => {
                const cleanQuestion = ex.question.replace(/\*\*/g, '');
                html += `<div class="exercise p-3 border-r-4 border-slate-200" data-answer="${ex.answer}">`;
                if (ex.type === 'fill_in_the_blank') {
                    html += `<p class="font-urdu text-lg">${index + 1}. ${cleanQuestion.replace('___', '<input type="text" class="exercise-input border-b-2 bg-transparent text-center w-24 mx-1 font-urdu text-lg">')}</p>`;
                } else if (ex.type === 'multiple_choice') {
                    html += `<p class="font-urdu text-lg">${index + 1}. ${cleanQuestion}</p>
                             <div class="flex flex-wrap gap-2 mt-2">
                                ${ex.options.map(opt => `<label class="flex items-center gap-2 p-2 border rounded-md cursor-pointer font-urdu text-lg"><input type="radio" name="ex${index}" value="${opt}" class="exercise-input">${opt}</label>`).join('')}
                             </div>`;
                } else if (ex.type === 'true_false') {
                     html += `<p class="font-urdu text-lg">${index + 1}. ${cleanQuestion}</p>
                              <div class="flex gap-4 mt-2">
                                 <label class="flex items-center gap-2 p-2 border rounded-md cursor-pointer"><input type="radio" name="ex${index}" value="true" class="exercise-input">صحیح</label>
                                 <label class="flex items-center gap-2 p-2 border rounded-md cursor-pointer"><input type="radio" name="ex${index}" value="false" class="exercise-input">غلط</label>
                              </div>`;
                }
                html += '</div>';
            });
            html += '</div><button id="check-answers-btn" class="mt-6 bg-green-600 text-white px-6 py-2 rounded-md hover:bg-green-700">تحقق من الإجابات</button>';
            html += '<div id="results-container" class="mt-4"></div>';
            return html;
        }

        function checkAnswers() {
            const exercises = document.querySelectorAll('.exercise');
            let correctCount = 0;
            exercises.forEach(ex => {
                const correctAnswer = ex.dataset.answer.toLowerCase();
                const inputs = ex.querySelectorAll('.exercise-input');
                let userAnswer = '';
                ex.classList.remove('border-green-400', 'border-red-400');

                if (inputs.length > 0 && inputs[0].type === 'text') {
                    userAnswer = inputs[0].value.trim().toLowerCase();
                } else {
                    inputs.forEach(input => {
                        if (input.checked) {
                            userAnswer = input.value.toLowerCase();
                        }
                    });
                }
                
                if (userAnswer === correctAnswer) {
                    ex.classList.add('border-green-400'); correctCount++;
                } else { 
                    ex.classList.add('border-red-400'); 
                }
            });
            document.getElementById('results-container').innerHTML = `<p class="font-bold">نتيجتك: ${correctCount} من ${exercises.length} إجابات صحيحة.</p>`;
        }

        function handleNewLesson() {
            const newWords = selectNewWords();
            if (newWords.length > 0) {
                generateLesson(newWords, false, false);
            } else {
                isLessonActive = false;
                showScreen(allDOMElements.homeScreen);
            }
        }

        function handleRevisionLesson() {
            const wordsForRevision = [...learnedWords].sort(() => 0.5 - Math.random()).slice(0, 15);
            if (wordsForRevision.length > 0) {
                generateLesson(wordsForRevision, false, true);
            }
        }

        function renderHistory() {
            if (lessonHistory.length === 0) {
                allDOMElements.historyList.innerHTML = '<p class="text-center text-slate-500">لا توجد دروس محفوظة بعد.</p>';
                return;
            }
            allDOMElements.historyList.innerHTML = lessonHistory.map((lesson, index) => `
                <div class="p-3 border rounded-md hover:bg-slate-100 cursor-pointer" onclick="viewHistoryItem(${index})">
                    <p class="font-bold">درس بتاريخ: ${lesson.date}</p>
                    <p class="text-sm text-slate-600 font-urdu">${lesson.learnedWords.slice(0, 5).join('، ')}...</p>
                </div>
            `).join('');
        }

        function viewHistoryItem(index) {
            const lessonData = lessonHistory[index];
            renderLesson(lessonData, false);
            isLessonActive = true;
            showTab('home');
        }
        
        async function getTranslation(text) {
            const prompt = `Translate the Urdu text "${text}" into a simple, direct Arabic equivalent. Provide only the translation, nothing else.`;
            return await callGeminiForSimpleText(prompt, true);
        }

        async function getPhonetics(text) {
            const prompt = `اكتب النطق التقريبي لهذه الكلمة أو الجملة الأردية "${text}" باستخدام حروف عربية مبسطة. فقط أعط النطق ولا شيء آخر.`;
            return await callGeminiForSimpleText(prompt, true);
        }
        
        async function callGeminiForSimpleText(prompt, hideLoading) {
            if (!apiKey) { showModal('الرجاء حفظ مفتاح Gemini API أولاً.'); return null; }
            if (!hideLoading) showScreen(allDOMElements.loadingScreen);
            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                if (!response.ok) throw new Error('API Error');
                const result = await response.json();
                if (!hideLoading) showTab(document.querySelector('[id^="nav-"][class*="border-sky-600"]').id.split('-')[1]);
                return result.candidates[0].content.parts[0].text.trim();
            } catch (error) {
                console.error('Error with simple text generation:', error);
                showModal('حدث خطأ أثناء التواصل مع الذكاء الاصطناعي.');
                if (!hideLoading) showTab(document.querySelector('[id^="nav-"][class*="border-sky-600"]').id.split('-')[1]);
                return null;
            }
        }

        async function saveToBasket(urduText, arabicText) {
            if (!arabicText) {
                arabicText = await getTranslation(urduText);
                if (!arabicText) {
                     showModal('لم يتم العثور على ترجمة.');
                     return;
                }
            }

            const isAlreadySaved = learningBasket.some(item => item.ur.toLowerCase() === urduText.toLowerCase());
            if (isAlreadySaved) {
                showModal(`<span class="font-urdu text-lg">"${urduText}"</span> <br><br> موجودة بالفعل في سلة التعلم.`);
                return;
            }
            
            learningBasket.unshift({ id: Date.now(), ur: urduText, ar: arabicText });
            saveState();
            showModal(`<span class="font-urdu text-lg">"${urduText}"</span> <br><br> تم حفظها بنجاح في سلة التعلم!`);
        }

        function renderLearnedWords() {
            const container = allDOMElements.learnedWordsScreen;
            const buttonHtml = learnedWords.length >= 15
                ? `<div class="text-center mb-6"><button id="review-lesson-btn" class="bg-sky-600 text-white px-6 py-2 rounded-md hover:bg-sky-700 transition">مراجعة بقصة جديدة</button></div>`
                : `<p class="text-center text-slate-500 mb-6">تحتاج لتعلم ${15 - learnedWords.length} كلمات أخرى على الأقل لبدء المراجعة بقصة.</p>`;

            const wordsHtml = learnedWords.length === 0 
                ? '<p class="text-center text-slate-500">لم تتعلم أي كلمات بعد. ابدأ درساً جديداً!</p>'
                : `<div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                    ${[...learnedWords].sort().map(word => `
                        <div class="font-urdu text-lg p-3 border rounded-md text-center cursor-pointer hover:bg-sky-100" onclick="showWordActionModal('${word}')">
                            ${word}
                        </div>
                    `).join('')}
                   </div>`;
            
            container.innerHTML = createSection('الكلمات التي تعلمتها', wordsHtml, buttonHtml);

            if (learnedWords.length >= 15) {
                document.getElementById('review-lesson-btn').addEventListener('click', handleRevisionLesson);
            }
        }

        function renderBasket() {
            const basketContainer = allDOMElements.basketScreen;
            if (learningBasket.length === 0) {
                basketContainer.innerHTML = createSection('سلة التعلم', '<p class="text-center text-slate-500">سلّتك فارغة. ابدأ بحفظ الكلمات والجمل لمراجعتها هنا.</p>');
                return;
            }

            const flashcardsHtml = `
                <div class="flashcard-container">
                    ${learningBasket.map(item => `
                        <div class="flashcard" onclick="this.classList.toggle('is-flipped')">
                            <div class="flashcard-inner">
                                <div class="flashcard-front font-urdu">${item.ur}</div>
                                <div class="flashcard-back">${item.ar}</div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;

            const matchingHtml = renderMatchingExercise();

            basketContainer.innerHTML = `
                ${createSection('1. بطاقات تعليمية (Flashcards)', '<p class="mb-4 text-sm text-slate-500">اضغط على البطاقة لقلبها ورؤية الترجمة.</p>' + flashcardsHtml)}
                ${createSection('2. تمرين التوصيل', '<p class="mb-4 text-sm text-slate-500">صل الكلمة الأردية بترجمتها الصحيحة.</p>' + matchingHtml)}
            `;
            
            setupMatchingExerciseListeners();
        }
        
        function renderMatchingExercise() {
            const shuffledUr = [...learningBasket].sort(() => 0.5 - Math.random());
            const shuffledAr = [...learningBasket].sort(() => 0.5 - Math.random());

            const urHtml = shuffledUr.map(item => 
                `<div class="match-item font-urdu" data-id="${item.id}">${item.ur}</div>`
            ).join('');
            const arHtml = shuffledAr.map(item => 
                `<div class="match-item" data-id="${item.id}">${item.ar}</div>`
            ).join('');

            return `
                <div class="matching-container">
                    <div class="matching-column">${urHtml}</div>
                    <div class="matching-column">${arHtml}</div>
                </div>
                <p id="match-result" class="text-center font-bold mt-4"></p>
            `;
        }

        function setupMatchingExerciseListeners() {
            let selectedUr = null;
            let selectedAr = null;
            const items = document.querySelectorAll('.match-item');

            items.forEach(item => {
                item.addEventListener('click', () => {
                    const isUrdu = item.classList.contains('font-urdu');
                    
                    if (isUrdu) {
                        if (selectedUr) selectedUr.classList.remove('selected');
                        selectedUr = item;
                        item.classList.add('selected');
                    } else {
                        if (selectedAr) selectedAr.classList.remove('selected');
                        selectedAr = item;
                        item.classList.add('selected');
                    }

                    if (selectedUr && selectedAr) {
                        if (selectedUr.dataset.id === selectedAr.dataset.id) {
                            selectedUr.classList.add('correct');
                            selectedAr.classList.add('correct');
                            document.getElementById('match-result').textContent = 'صحيح!';
                            document.getElementById('match-result').style.color = 'green';
                        } else {
                            selectedUr.classList.add('incorrect');
                            selectedAr.classList.add('incorrect');
                            document.getElementById('match-result').textContent = 'حاول مرة أخرى!';
                             document.getElementById('match-result').style.color = 'red';
                            setTimeout(() => {
                                selectedUr.classList.remove('incorrect');
                                selectedAr.classList.remove('incorrect');
                            }, 1000);
                        }
                        if (selectedUr) selectedUr.classList.remove('selected');
                        if (selectedAr) selectedAr.classList.remove('selected');
                        selectedUr = null;
                        selectedAr = null;
                    }
                });
            });
        }

        async function speakText(text, mood = 'neutral') {
            resumeAudioContext();
            if (!apiKey || !audioContext) {
                showModal('ميزة الصوت غير متاحة. يرجى التحقق من مفتاح API أو دعم المتصفح.');
                return;
            }
            const cleanText = text.replace(/<[^>]*>?/gm, '');
            const randomVoice = ttsVoices[Math.floor(Math.random() * ttsVoices.length)];
            const promptText = `Please say this in Urdu with a standard, clear accent: ${cleanText}`;

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        model: "gemini-2.5-flash-preview-tts",
                        contents: [{ parts: [{ text: promptText }] }],
                        generationConfig: { 
                            responseModalities: ["AUDIO"],
                            speechConfig: {
                                voiceConfig: {
                                    prebuiltVoiceConfig: { voiceName: randomVoice }
                                }
                            }
                        },
                    })
                });
                if (!response.ok) throw new Error(`TTS API Error: ${response.status}`);
                const result = await response.json();
                const audioData = result?.candidates?.[0]?.content?.parts?.[0]?.inlineData?.data;
                if (audioData) {
                    const pcmData = base64ToArrayBuffer(audioData);
                    const pcm16 = new Int16Array(pcmData);
                    const wavBlob = pcmToWav(pcm16, 24000);
                    const audioUrl = URL.createObjectURL(wavBlob);
                    new Audio(audioUrl).play();
                } else {
                     throw new Error("No audio data received from API.");
                }
            } catch (error) {
                console.error('Error with TTS:', error);
                showModal('حدث خطأ أثناء تشغيل الصوت. قد لا تدعم واجهة برمجة التطبيقات نطق هذه العبارة.');
            }
        }

        function base64ToArrayBuffer(base64) {
            const binaryString = window.atob(base64);
            const len = binaryString.length;
            const bytes = new Uint8Array(len);
            for (let i = 0; i < len; i++) { bytes[i] = binaryString.charCodeAt(i); }
            return bytes.buffer;
        }

        function pcmToWav(pcmData, sampleRate) {
            const view = new DataView(new ArrayBuffer(44 + pcmData.length * 2));
            writeString(view, 0, 'RIFF'); view.setUint32(4, 36 + pcmData.length * 2, true);
            writeString(view, 8, 'WAVE'); writeString(view, 12, 'fmt ');
            view.setUint32(16, 16, true); view.setUint16(20, 1, true);
            view.setUint16(22, 1, true); view.setUint32(24, sampleRate, true);
            view.setUint32(28, sampleRate * 2, true); view.setUint16(32, 2, true);
            view.setUint16(34, 16, true); writeString(view, 36, 'data');
            view.setUint32(40, pcmData.length * 2, true);
            for (let i = 0; i < pcmData.length; i++) { view.setInt16(44 + i * 2, pcmData[i], true); }
            return new Blob([view], { type: 'audio/wav' });
        }
        
        function writeString(view, offset, string) {
            for (let i = 0; i < string.length; i++) {
                view.setUint8(offset + i, string.charCodeAt(i));
            }
        }

        function handleSaveApiKey() {
            const key = allDOMElements.apiKeyInput.value.trim();
            if (key) {
                apiKey = key;
                localStorage.setItem('geminiApiKey_ur', key);
                allDOMElements.apiKeySection.classList.add('hidden');
                allDOMElements.mainContent.classList.remove('hidden');
            } else {
                showModal('الرجاء إدخال مفتاح API صحيح.');
            }
        }
        
        function handleResetProgress() {
            const isConfirmed = window.confirm('هل أنت متأكد أنك تريد إعادة تعيين كل تقدمك؟ سيتم حذف جميع الكلمات والدروس المحفوظة.');
            if (isConfirmed) {
                learnedWords = [];
                learningBasket = [];
                lessonHistory = [];
                isLessonActive = false;
                saveState();
                updateProgress();
                showTab('home');
            }
        }

        // --- Alphabet Feature Functions ---
        function renderAlphabetScreen() {
            const container = allDOMElements.alphabetScreen;
            const alphabetHtml = urduAlphabet.map(letter => `
                <div class="letter-card font-urdu" data-letter="${letter}">
                    ${letter}
                </div>
            `).join('');

            container.innerHTML = createSection(
                'الأبجدية الأردية',
                '<p class="text-center text-slate-500 mb-6">اضغط على أي حرف لسماع نطقه وتعلم المزيد عنه.</p>' + `<div class="alphabet-grid">${alphabetHtml}</div>`
            );
            
            container.querySelectorAll('.letter-card').forEach(card => {
                card.addEventListener('click', handleLetterClick);
            });
        }

        function handleLetterClick(event) {
            const letter = event.currentTarget.dataset.letter;
            getLetterInfo(letter);
        }

        async function getLetterInfo(letter) {
            const prompt = `
            You are an expert Urdu teacher for Arabic speakers.
            Your task is to provide information about a single Urdu letter.
            The letter is: "${letter}"

            **RULES:**
            1.  Provide the information in a clear, simple format for a beginner.
            2.  The entire response must be a single, valid JSON object.
            3.  All text values in the JSON must be in Arabic, except for the letter and example word.

            **Required JSON Structure:**
            {
              "letter_name": "اسم الحرف (مثلاً: الف)",
              "pronunciation_guide": "شرح لكيفية نطق الحرف، مع مقارنته بصوت عربي مشابه إن أمكن.",
              "example_word": "كلمة مثال تبدأ بالحرف (بالأردية)",
              "example_word_translation": "ترجمة كلمة المثال (بالعربية)"
            }
            `;
            
            const letterData = await callGeminiForSimpleText(prompt, false);
            if (letterData) {
                try {
                    const parsedData = JSON.parse(letterData);
                    const modalContent = `
                        <div class="text-right space-y-4">
                            <p><strong class="font-bold">اسم الحرف:</strong> ${parsedData.letter_name}</p>
                            <p><strong class="font-bold">كيفية النطق:</strong> ${parsedData.pronunciation_guide}</p>
                            <hr>
                            <p class="text-lg"><strong class="font-bold">مثال:</strong> <span class="font-urdu text-2xl">${parsedData.example_word}</span> (${parsedData.example_word_translation})</p>
                        </div>
                    `;
                    
                    const actions = [{
                        text: `🔊 نطق الحرف`,
                        class: 'speak-letter-btn bg-sky-500 text-white hover:bg-sky-600',
                        callback: () => speakText(letter),
                        keepOpen: true
                    }, {
                        text: `🔊 نطق المثال`,
                        class: 'speak-example-btn bg-green-500 text-white hover:bg-green-600',
                        callback: () => speakText(parsedData.example_word),
                        keepOpen: true
                    }];

                    showModal(modalContent, `تعلم حرف <span class="font-urdu text-3xl">${letter}</span>`, actions);
                } catch(e) {
                    console.error("Failed to parse letter info JSON", e);
                    showModal("حدث خطأ في عرض معلومات الحرف.");
                }
            }
        }

        initialize();
    </script>
</body>
</html>
